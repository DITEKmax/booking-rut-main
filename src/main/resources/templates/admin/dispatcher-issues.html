<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/header :: head}">
    <title>Dispatcher Issues - RUT Booking</title>
</head>
<body>
    <header th:replace="~{fragments/header :: header}"></header>

    <main class="main-content">
        <div class="admin-container">
            <!-- Admin Sidebar -->
            <aside class="admin-sidebar">
                <nav class="admin-nav">
                    <a th:href="@{/admin}" class="admin-nav-link">Dashboard</a>
                    <a th:href="@{/admin/bookings}" class="admin-nav-link">All Bookings</a>
                    <a th:href="@{/admin/calendar}" class="admin-nav-link">Calendar</a>
                    <a th:href="@{/admin/reviews}" class="admin-nav-link">Reviews</a>
                    <a th:href="@{/admin/dispatcher-issues}" class="admin-nav-link active">Reported Issues</a>
                </nav>
            </aside>

            <!-- Admin Content -->
            <div class="admin-content">
                <h1>Reported Issues from Reviews</h1>

                <div th:if="${success}" class="alert alert-success">
                    <span th:text="${success}">Success message</span>
                </div>

                <div th:if="${error}" class="alert alert-error">
                    <span th:text="${error}">Error message</span>
                </div>

                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    This page shows all reviews where users have reported problems with classrooms.
                    Issues include: broken equipment, missing markers, cleanliness problems, etc.
                </p>

                <!-- Issues Table -->
                <div class="bookings-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Room</th>
                                <th>User</th>
                                <th>Rating</th>
                                <th>Issues Reported</th>
                                <th>Comment</th>
                                <th>Image</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${#lists.isEmpty(reviews)}">
                                <td colspan="9" class="no-data">No issues reported</td>
                            </tr>
                            <tr th:each="review : ${reviews}">
                                <td th:text="${review.id}">#123</td>
                                <td th:text="${#temporals.format(review.createdAt, 'dd.MM.yyyy HH:mm')}">01.01.2025 10:00</td>
                                <td th:text="'Room ' + ${review.roomNumber}">Room 1234</td>
                                <td th:text="${review.userName}">User Name</td>
                                <td>
                                    <span class="rating-stars">
                                        <span th:each="i : ${#numbers.sequence(1, review.rating)}">‚≠ê</span>
                                    </span>
                                    <span th:text="${review.rating}">(5)</span>
                                </td>
                                <td>
                                    <div class="issues-list">
                                        <span th:each="issue, iterStat : ${#strings.arraySplit(review.issues, ',')}"
                                              class="issue-badge"
                                              th:text="${issue}">Issue</span>
                                    </div>
                                </td>
                                <td class="purpose-cell" th:text="${review.comment}">Great room!</td>
                                <td>
                                    <a th:if="${review.imagePath}" th:href="${review.imagePath}" target="_blank" class="btn btn-outline btn-sm">View</a>
                                    <span th:unless="${review.imagePath}">-</span>
                                </td>
                                <td class="actions-cell">
                                    <a th:href="@{/rooms/{id}(id=${review.roomId})}" class="btn btn-outline btn-sm">View Room</a>
                                    <form th:if="${!review.issuesMarkedRelevant}" th:action="@{/admin/dispatcher-issues/{id}/mark-relevant(id=${review.id})}" method="post" style="display: inline; margin-left: 8px;">
                                        <button type="submit" class="btn btn-primary btn-sm">Mark Relevant</button>
                                    </form>
                                    <span th:if="${review.issuesMarkedRelevant}" class="badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">
                                        ‚úì Marked Relevant
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div th:if="${!#lists.isEmpty(reviews)}" style="margin-top: 20px; padding: 15px; background: var(--light-bg); border-radius: var(--radius-md);">
                    <h3 style="margin-bottom: 10px;">Issue Types:</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li>üîß <strong>–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ—Ä</strong> - Projector doesn't work</li>
                        <li>‚úèÔ∏è <strong>–ù–µ—Ç –º–∞—Ä–∫–µ—Ä–æ–≤</strong> - No markers</li>
                        <li>ü™ë <strong>–°–ª–æ–º–∞–Ω–∞ –ø–∞—Ä—Ç–∞/—Å—Ç—É–ª</strong> - Broken furniture</li>
                        <li>üíª <strong>–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä</strong> - Computer doesn't work</li>
                        <li>ü™ü <strong>–°–ª–æ–º–∞–Ω–æ –æ–∫–Ω–æ</strong> - Broken window</li>
                        <li>üßπ <strong>–ì—Ä—è–∑–Ω–æ</strong> - Dirty</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <script th:src="@{/js/main.js}"></script>

    <style>
        .issues-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .issue-badge {
            display: inline-block;
            padding: 4px 8px;
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            font-size: 12px;
            color: #856404;
            white-space: nowrap;
        }
    </style>
</body>
</html>
