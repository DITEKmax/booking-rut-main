<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/header :: head}">
    <title>Сообщенные проблемы - РУТ Навигатор</title>
</head>
<body>
    <header th:replace="~{fragments/header :: header}"></header>

    <main class="main-content">
        <div class="admin-container">
            <!-- Admin Sidebar -->
            <aside class="admin-sidebar">
                <nav class="admin-nav">
                    <a th:href="@{/admin}" class="admin-nav-link">Панель управления</a>
                    <a th:href="@{/admin/bookings}" class="admin-nav-link">Все бронирования</a>
                    <a th:href="@{/admin/calendar}" class="admin-nav-link">Календарь</a>
                    <a th:href="@{/admin/reviews}" class="admin-nav-link">Отзывы</a>
                    <a th:href="@{/admin/dispatcher-issues}" class="admin-nav-link active">Сообщенные проблемы</a>
                </nav>
            </aside>

            <!-- Admin Content -->
            <div class="admin-content">
                <h1>Сообщенные проблемы из отзывов</h1>

                <div th:if="${success}" class="alert alert-success">
                    <span th:text="${success}">Успешно</span>
                </div>

                <div th:if="${error}" class="alert alert-error">
                    <span th:text="${error}">Ошибка</span>
                </div>

                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    На этой странице отображаются все сообщения о проблемах с аудиториями.
                    Проблемы включают: сломанное оборудование, отсутствие маркеров, проблемы с чистотой и т.д.
                </p>

                <!-- Standalone Room Issues -->
                <div th:unless="${#lists.isEmpty(roomIssues)}" style="margin-bottom: 32px;">
                    <h3 style="margin-bottom: 16px;">Сообщения о проблемах</h3>
                    <div class="issues-table-wrapper">
                        <table class="issues-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">ID</th>
                                    <th style="width: 140px;">Дата</th>
                                    <th style="width: 180px;">Аудитория / Статус</th>
                                    <th style="width: 150px;">Пользователь</th>
                                    <th style="width: 200px;">Проблемы</th>
                                    <th>Описание</th>
                                    <th style="width: 100px;">Фото</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="issue : ${roomIssues}">
                                    <td th:text="${issue.id}">#1</td>
                                    <td th:text="${#temporals.format(issue.createdAt, 'dd.MM.yyyy HH:mm')}">01.01.2025</td>
                                    <td class="room-cell">
                                        <a th:href="@{/rooms/{id}(id=${issue.roomId})}" class="room-link">
                                            <span th:text="'Ауд. ' + ${issue.roomNumber}">Ауд. 1234</span>
                                        </a>
                                        <div style="margin-top: 8px;">
                                            <form th:if="${!issue.isResolved}" th:action="@{/admin/room-issues/{id}/mark-resolved(id=${issue.id})}" method="post">
                                                <button type="submit" class="btn btn-danger btn-sm">
                                                    Устранить
                                                </button>
                                            </form>
                                            <span th:if="${issue.isResolved}" class="badge badge-resolved">
                                                ✓ Устранено
                                            </span>
                                        </div>
                                    </td>
                                    <td th:text="${issue.userName}">Пользователь</td>
                                    <td>
                                        <div class="issues-list">
                                            <span th:each="iss : ${#strings.arraySplit(issue.issues, ',')}"
                                                  class="issue-badge" th:text="${iss}">Проблема</span>
                                        </div>
                                    </td>
                                    <td class="description-cell">
                                        <span th:text="${issue.description != null ? issue.description : '-'}">Описание</span>
                                    </td>
                                    <td>
                                        <a th:if="${issue.imagePath}" th:href="${issue.imagePath}" target="_blank" class="btn btn-outline btn-sm">Просмотр</a>
                                        <span th:unless="${issue.imagePath}">-</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Review Issues -->
                <div th:unless="${#lists.isEmpty(reviews)}">
                    <h3 style="margin-bottom: 16px;">Проблемы из отзывов</h3>
                    <div class="issues-table-wrapper">
                        <table class="issues-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">ID</th>
                                    <th style="width: 140px;">Дата</th>
                                    <th style="width: 180px;">Аудитория / Статус</th>
                                    <th style="width: 150px;">Пользователь</th>
                                    <th style="width: 80px;">Рейтинг</th>
                                    <th style="width: 200px;">Проблемы</th>
                                    <th>Комментарий</th>
                                    <th style="width: 100px;">Фото</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="review : ${reviews}">
                                    <td th:text="${review.id}">#123</td>
                                    <td th:text="${#temporals.format(review.createdAt, 'dd.MM.yyyy HH:mm')}">01.01.2025 10:00</td>
                                    <td class="room-cell">
                                        <a th:href="@{/rooms/{id}(id=${review.roomId})}" class="room-link">
                                            <span th:text="'Ауд. ' + ${review.roomNumber}">Ауд. 1234</span>
                                        </a>
                                        <div style="margin-top: 8px;">
                                            <form th:if="${!review.issuesMarkedRelevant}" th:action="@{/admin/dispatcher-issues/{id}/mark-relevant(id=${review.id})}" method="post">
                                                <button type="submit" class="btn btn-danger btn-sm">
                                                    Устранить
                                                </button>
                                            </form>
                                            <span th:if="${review.issuesMarkedRelevant}" class="badge badge-resolved">
                                                ✓ Устранено
                                            </span>
                                        </div>
                                    </td>
                                    <td th:text="${review.userName}">Имя пользователя</td>
                                    <td><span th:text="${review.rating}">5</span></td>
                                    <td>
                                        <div class="issues-list">
                                            <span th:each="issue : ${#strings.arraySplit(review.issues, ',')}"
                                                  class="issue-badge" th:text="${issue}">Проблема</span>
                                        </div>
                                    </td>
                                    <td class="description-cell">
                                        <span th:text="${review.comment != null ? review.comment : '-'}">Комментарий</span>
                                    </td>
                                    <td>
                                        <a th:if="${review.imagePath}" th:href="${review.imagePath}" target="_blank" class="btn btn-outline btn-sm">Просмотр</a>
                                        <span th:unless="${review.imagePath}">-</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Empty State -->
                <div th:if="${#lists.isEmpty(reviews) && #lists.isEmpty(roomIssues)}" class="no-data" style="padding: 40px; text-align: center;">
                    <p>Проблемы не сообщены</p>
                </div>
            </div>
        </div>
    </main>

    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <script th:src="@{/js/main.js}"></script>

    <style>
        .issues-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .issue-badge {
            display: inline-block;
            padding: 4px 8px;
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            font-size: 11px;
            color: #856404;
            white-space: nowrap;
        }

        .issues-table-wrapper {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .issues-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .issues-table th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        .issues-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
        }

        .issues-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .room-cell {
            text-align: left;
        }

        .room-link {
            color: var(--primary-color, #0066cc);
            text-decoration: none;
            font-weight: 500;
            display: inline-block;
            transition: color 0.2s ease;
        }

        .room-link:hover {
            color: var(--primary-dark, #0052a3);
            text-decoration: underline;
        }

        .room-cell .btn {
            font-size: 12px;
            padding: 6px 12px;
            white-space: nowrap;
        }

        .room-cell form {
            margin: 0;
        }

        .badge-resolved {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        .description-cell {
            max-width: 300px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .description-cell span {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        h3 {
            color: #333;
            font-size: 1.25rem;
            font-weight: 600;
        }
    </style>
</body>
</html>
