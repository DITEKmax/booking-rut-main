<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/header :: head}">
    <title>Календарь - РУТ Навигатор</title>
    <link rel="stylesheet" th:href="@{/css/calendar.css}">
</head>
<body>
    <header th:replace="~{fragments/header :: header}"></header>

    <main class="main-content">
        <div class="admin-container">
            <!-- Admin Sidebar -->
            <aside class="admin-sidebar">
                <nav class="admin-nav">
                    <a th:href="@{/admin}" class="admin-nav-link">Панель управления</a>
                    <a th:href="@{/admin/bookings}" class="admin-nav-link">Все бронирования</a>
                    <a th:href="@{/admin/calendar}" class="admin-nav-link active">Календарь</a>
                    <a th:href="@{/admin/reviews}" class="admin-nav-link">Отзывы</a>
                    <a th:href="@{/admin/dispatcher-issues}" class="admin-nav-link">Сообщенные проблемы</a>
                </nav>
            </aside>

            <!-- Admin Content -->
            <div class="admin-content">
                <h1>Календарь занятости аудиторий</h1>

                <!-- Room Filter -->
                <div class="calendar-filters">
                    <form th:action="@{/admin/calendar}" method="get" class="filter-form">
                        <div class="filter-group">
                            <label for="roomId">Аудитория</label>
                            <select name="roomId" id="roomId" class="filter-select" onchange="this.form.submit()">
                                <option value="">Все аудитории</option>
                                <option th:each="r : ${rooms}" th:value="${r.id}"
                                        th:text="'Аудитория ' + ${r.number}" th:selected="${selectedRoomId == r.id}">Аудитория</option>
                            </select>
                        </div>
                    </form>
                </div>

                    <!-- Calendar -->
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button class="btn btn-outline" onclick="navigateWeek(-1)">&larr; Предыдущая неделя</button>
                            <div class="calendar-month-display">
                                <h2 id="currentMonthYear">Январь 2025</h2>
                                <p id="currentWeekRange" style="font-size: 0.9rem; color: #666; margin: 0;">Неделя</p>
                            </div>
                            <button class="btn btn-outline" onclick="navigateWeek(1)">Следующая неделя &rarr;</button>
                        </div>

                        <div class="calendar-legend">
                            <span class="legend-item"><span class="legend-color approved"></span> Одобрено</span>
                            <span class="legend-item"><span class="legend-color pending"></span> Ожидает</span>
                            <span class="legend-item"><span class="legend-color rejected"></span> Отклонено</span>
                        </div>

                        <!-- Time-Tree Calendar -->
                        <div class="timetable-container">
                            <table class="timetable">
                                <thead>
                                    <tr>
                                        <th class="time-column">Время</th>
                                        <th class="day-column" id="day-0">Пн</th>
                                        <th class="day-column" id="day-1">Вт</th>
                                        <th class="day-column" id="day-2">Ср</th>
                                        <th class="day-column" id="day-3">Чт</th>
                                        <th class="day-column" id="day-4">Пт</th>
                                        <th class="day-column" id="day-5">Сб</th>
                                        <th class="day-column" id="day-6">Вс</th>
                                    </tr>
                                </thead>
                                <tbody id="timetableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <script th:src="@{/js/main.js}"></script>
    <script th:inline="javascript">
        const selectedRoomId = [[${selectedRoomId}]];
        let currentWeekStart = getMonday(new Date());
        let events = [];

        // Time periods matching ClassPeriod enum
        const timePeriods = [
            { number: 1, start: '08:30', end: '09:50', name: '1-я пара' },
            { number: 2, start: '10:05', end: '11:25', name: '2-я пара' },
            { number: 3, start: '11:40', end: '13:00', name: '3-я пара' },
            { number: 4, start: '13:45', end: '15:05', name: '4-я пара' },
            { number: 5, start: '15:20', end: '16:40', name: '5-я пара' },
            { number: 6, start: '16:55', end: '18:15', name: '6-я пара' },
            { number: 7, start: '18:30', end: '19:50', name: '7-я пара' },
            { number: 8, start: '20:00', end: '21:20', name: '8-я пара' }
        ];

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function navigateWeek(delta) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (delta * 7));
            renderCalendar();
            loadEvents();
        }

        function renderCalendar() {
            // Update month/year display
            const monthYear = currentWeekStart.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            document.getElementById('currentMonthYear').textContent = monthYear.charAt(0).toUpperCase() + monthYear.slice(1);

            // Update week range
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const weekRange = `${currentWeekStart.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            document.getElementById('currentWeekRange').textContent = weekRange;

            // Update day headers
            const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const dayHeader = document.getElementById(`day-${i}`);
                dayHeader.innerHTML = `
                    <div>${dayNames[i]}</div>
                    <div style="font-size: 0.8rem; font-weight: normal;">${date.getDate()}</div>
                `;
            }

            // Render timetable body
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = '';

            timePeriods.forEach(period => {
                const row = document.createElement('tr');

                // Time column
                const timeCell = document.createElement('td');
                timeCell.className = 'time-cell';
                timeCell.innerHTML = `
                    <div class="time-label">
                        <strong>${period.name}</strong><br>
                        <span style="font-size: 0.85rem;">${period.start} - ${period.end}</span>
                    </div>
                `;
                row.appendChild(timeCell);

                // Day columns
                for (let i = 0; i < 7; i++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + i);
                    const dateStr = formatDate(date);

                    const dayCell = document.createElement('td');
                    dayCell.className = 'booking-cell';

                    // Find bookings for this date and period
                    const cellBookings = events.filter(e =>
                        e.date === dateStr && e.period === period.number
                    );

                    if (cellBookings.length > 0) {
                        cellBookings.forEach(booking => {
                            const bookingDiv = document.createElement('div');
                            bookingDiv.className = `booking-item ${booking.status.toLowerCase()}`;
                            bookingDiv.innerHTML = `
                                <div class="booking-room">Ауд. ${booking.roomNumber}</div>
                                <div class="booking-teacher">${booking.teacherName}</div>
                                <div class="booking-purpose">${booking.purpose || ''}</div>
                            `;
                            bookingDiv.onclick = () => showBookingDetails(booking);
                            dayCell.appendChild(bookingDiv);
                        });
                    } else {
                        dayCell.innerHTML = '<span class="empty-slot">—</span>';
                    }

                    row.appendChild(dayCell);
                }

                tbody.appendChild(row);
            });
        }

        function loadEvents() {
            const start = formatDate(currentWeekStart);
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const end = formatDate(weekEnd);

            let url = `/admin/api/calendar-events?start=${start}&end=${end}`;
            if (selectedRoomId) {
                url += `&roomId=${selectedRoomId}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    events = data;
                    renderCalendar();
                });
        }

        function showBookingDetails(booking) {
            window.location.href = `/admin/bookings/${booking.bookingId}`;
        }

        // Initial load
        loadEvents();
    </script>
</body>
</html>
