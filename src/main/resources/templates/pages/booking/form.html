<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragments/header :: head}">

    <title th:text="'Бронирование ' + ${room.number} + ' - РУТ Навигатор'">Бронирование - РУТ Навигатор</title>

</head>

<body>

<header th:replace="~{fragments/header :: header}"></header>



<main class="main-content">

    <div class="booking-page">

        <!-- Breadcrumb -->

        <div class="breadcrumb">

            <a th:href="@{/rooms}">План</a> / <a th:href="@{/rooms/{id}(id=${room.id})}" th:text="${room.number}">1125</a> / <span th:text="'Бронирование ' + ${room.number}">Бронирование 1125</span>

        </div>



        <!-- User Profile Card -->

        <div class="user-profile-card">

            <div class="user-avatar">&#128100;</div>

            <div class="user-profile-info">

                <h3 th:text="${user.fullName}">Иванов Иван Иванович</h3>

                <p class="user-role" th:text="${user.roleDisplayName}">Старший преподаватель</p>

            </div>

        </div>



        <!-- Alert Messages -->

        <div th:if="${error}" class="alert alert-error">

            <span th:text="${error}">Ошибка</span>

        </div>



        <!-- Booking Form with Calendar -->

        <form th:action="@{/booking/create}" method="post" th:object="${bookingRequest}" class="booking-form">

            <input type="hidden" th:field="*{roomId}">



            <div class="form-section">

                <h3>Выбор даты и времени</h3>



                <!-- Calendar Section -->

                <div class="calendar-section">

                    <div class="calendar-header">

                        <div class="calendar-month">

                            <span id="currentMonth">Апрель 2024</span>

                            <span>&#9662;</span>

                        </div>

                        <div class="calendar-nav">

                            <button type="button" onclick="prevMonth()">&lt;</button>

                            <button type="button" onclick="nextMonth()">&gt;</button>

                        </div>

                    </div>



                    <div class="calendar-grid" id="calendarGrid">

                        <div class="calendar-day-header">Пн</div>

                        <div class="calendar-day-header">Вт</div>

                        <div class="calendar-day-header">Ср</div>

                        <div class="calendar-day-header">Чт</div>

                        <div class="calendar-day-header">Пт</div>

                        <div class="calendar-day-header weekend">Сб</div>

                        <div class="calendar-day-header weekend">Вс</div>

                        <!-- Calendar days will be generated by JavaScript -->

                    </div>



                    <input type="hidden" id="bookingDate" th:field="*{bookingDate}"

                           th:min="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"

                           onchange="loadAvailablePeriods()">

                    <span th:if="${#fields.hasErrors('bookingDate')}" class="error-message"

                          th:errors="*{bookingDate}">Ошибка даты</span>

                </div>



                <!-- Time Slots -->

                <div class="form-group">

                    <label>Доступные временные слоты</label>

                    <div class="time-slots" id="timeSlots">

                        <div th:each="period : ${allPeriods}" class="time-slot"

                             th:classappend="${#lists.contains(availablePeriods, period)} ? '' : 'disabled'">

                            <input type="radio" th:id="${'period_' + period.name()}" name="classPeriod"

                                   th:value="${period.name()}"

                                   th:disabled="${!#lists.contains(availablePeriods, period)}"

                                   required>

                            <label th:for="${'period_' + period.name()}" class="time-slot-label">

                                <span class="period-name" th:text="${period.displayName}">1-я пара</span>

                                <span class="period-time" th:text="${period.timeRange}">8:30 – 9:50</span>

                            </label>

                        </div>

                    </div>

                    <span th:if="${#fields.hasErrors('classPeriod')}" class="error-message"

                          th:errors="*{classPeriod}">Ошибка периода</span>

                </div>

            </div>



            <div class="form-section">

                <h3>Детали бронирования</h3>



                <div class="form-group">

                    <label for="purpose">Цель бронирования *</label>

                    <input type="text" id="purpose" th:field="*{purpose}" class="form-control"

                           placeholder="Например: Лекция по математике, Семинар, Экзамен" required

                           minlength="5" maxlength="500">

                    <span th:if="${#fields.hasErrors('purpose')}" class="error-message"

                          th:errors="*{purpose}">Ошибка цели</span>

                </div>



                <div class="form-group">

                    <label for="notes">Дополнительные заметки (необязательно)</label>

                    <textarea id="notes" th:field="*{notes}" class="form-control" rows="3"

                              placeholder="Любые особые требования или примечания..."

                              maxlength="1000"></textarea>

                    <span th:if="${#fields.hasErrors('notes')}" class="error-message"

                          th:errors="*{notes}">Ошибка заметок</span>

                </div>

            </div>



            <div class="form-actions">

                <a th:href="@{/rooms/{id}(id=${room.id})}" class="btn btn-outline">Отмена</a>

                <button type="submit" class="btn btn-primary">Забронировать</button>

            </div>

        </form>



        <!-- Similar Rooms / Suggestions -->

        <div th:if="${!#lists.isEmpty(similarRooms)}" class="similar-rooms-section">

            <h2>Может подойти</h2>



            <div class="search-filters" style="margin-bottom: 24px;">

                <div class="search-bar">

                    <input type="text" placeholder="Поиск" class="search-input">

                    <button class="btn btn-primary">&#128269;</button>

                </div>

            </div>



            <div class="similar-rooms-grid">

                <div th:each="similarRoom : ${similarRooms}" class="room-card">

                    <div class="room-image">

                        <div th:if="${similarRoom.imagePath != null}" class="image-container">

                            <img th:src="${similarRoom.imagePath}" th:alt="${similarRoom.number}">

                        </div>

                        <div th:unless="${similarRoom.imagePath != null}" class="image-placeholder">

                            <span th:text="${similarRoom.number}">Аудитория</span>

                        </div>

                    </div>

                    <div class="room-info">

                        <h3 class="room-number" th:text="${similarRoom.number}">1124</h3>

                        <div class="room-rating">

                                <span class="rating-badge"

                                      th:classappend="${similarRoom.averageRating >= 4} ? 'good' : 'average'"

                                      th:text="${#numbers.formatDecimal(similarRoom.averageRating, 1, 1)}">4.0</span>

                        </div>

                        <p class="room-type" th:text="${similarRoom.roomType.displayName}">Компьютерная аудитория</p>

                        <p class="room-meta" th:text="${similarRoom.capacity} + ' мест'">100 мест</p>

                        <p th:if="${similarRoom.hasProjector}" class="feature-badge">Есть проектор</p>

                        <a th:href="@{/booking/room/{id}(id=${similarRoom.id})}" class="btn btn-primary btn-sm">Забронировать</a>

                    </div>

                </div>

            </div>



            <button class="show-more-btn">Показать ещё</button>

        </div>

    </div>

</main>



<footer th:replace="~{fragments/footer :: footer}"></footer>



<script th:src="@{/js/main.js}"></script>

<script th:inline="javascript">

    const roomId = [[${room.id}]];

    let currentDate = new Date();

    let selectedDate = null;



    const monthNames = [

        'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',

        'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'

    ];



    function renderCalendar() {

        const year = currentDate.getFullYear();

        const month = currentDate.getMonth();



        document.getElementById('currentMonth').textContent = monthNames[month] + ' ' + year;



        const firstDay = new Date(year, month, 1);

        const lastDay = new Date(year, month + 1, 0);



        // Adjust first day for Monday start (0 = Sunday in JS, but we want Monday = 0)

        let startDayOfWeek = firstDay.getDay() - 1;

        if (startDayOfWeek < 0) startDayOfWeek = 6;



        const grid = document.getElementById('calendarGrid');



        // Keep headers

        const headers = grid.querySelectorAll('.calendar-day-header');

        grid.innerHTML = '';

        headers.forEach(h => grid.appendChild(h));



        // Add empty cells for days before the first of the month

        for (let i = 0; i < startDayOfWeek; i++) {

            const emptyDay = document.createElement('div');

            emptyDay.className = 'calendar-day other-month';

            grid.appendChild(emptyDay);

        }



        // Add days

        const today = new Date();

        today.setHours(0, 0, 0, 0);



        for (let day = 1; day <= lastDay.getDate(); day++) {

            const dayCell = document.createElement('div');

            dayCell.className = 'calendar-day';

            dayCell.textContent = day;



            const cellDate = new Date(year, month, day);

            cellDate.setHours(0, 0, 0, 0);



            if (cellDate < today) {

                dayCell.className += ' other-month';

            } else {

                dayCell.onclick = function() {

                    selectDate(year, month, day);

                };

            }



            if (cellDate.getTime() === today.getTime()) {

                dayCell.className += ' today';

            }



            if (selectedDate && cellDate.getTime() === selectedDate.getTime()) {

                dayCell.className += ' selected';

            }



            grid.appendChild(dayCell);

        }

    }



    function prevMonth() {

        currentDate.setMonth(currentDate.getMonth() - 1);

        renderCalendar();

    }



    function nextMonth() {

        currentDate.setMonth(currentDate.getMonth() + 1);

        renderCalendar();

    }



    function selectDate(year, month, day) {

        selectedDate = new Date(year, month, day);

        const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');

        document.getElementById('bookingDate').value = dateStr;

        renderCalendar();

        loadAvailablePeriods();

    }



    function loadAvailablePeriods() {

        const date = document.getElementById('bookingDate').value;

        if (!date) return;



        fetch('/rooms/api/available-periods/' + roomId + '?date=' + date)

            .then(response => response.json())

            .then(periods => {

                const availableNames = periods.map(p => p.name);

                document.querySelectorAll('.time-slot').forEach(slot => {

                    const input = slot.querySelector('input');

                    const periodName = input.value;

                    if (availableNames.includes(periodName)) {

                        slot.classList.remove('disabled');

                        input.disabled = false;

                    } else {

                        slot.classList.add('disabled');

                        input.disabled = true;

                        input.checked = false;

                    }

                });

            });

    }



    // Initialize calendar on load

    document.addEventListener('DOMContentLoaded', function() {

        renderCalendar();

    });

</script>

</body>

</html>